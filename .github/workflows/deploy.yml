name: Deploy Recipe App

on:
  push:
    branches: [main, milestone1]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLECLOUD_CREDENTIALS }}
          
      - uses: google-github-actions/setup-gcloud@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and deploy backend
        run: |
          cd backend
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/recipe-backend:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/recipe-backend:latest
          
          gcloud run deploy recipe-backend \
            --image ${{ secrets.DOCKERHUB_USERNAME }}/recipe-backend:latest \
            --region us-central1 \
            --allow-unauthenticated \
            --port 8080 \
            --set-env-vars "MONGODB_URI=${{ secrets.MONGODB_URI }},JWT_SECRET=${{ secrets.JWT_SECRET }},NODE_ENV=production"
      
      - name: Get backend URL
        run: |
          BACKEND_URL=$(gcloud run services describe recipe-backend --region us-central1 --format="value(status.url)")
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
          echo "Backend deployed: $BACKEND_URL"
      
      - name: Build and deploy frontend
        run: |
          docker build --build-arg VITE_BACKEND_URL=$BACKEND_URL/api/v1 -t ${{ secrets.DOCKERHUB_USERNAME }}/recipe-frontend:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/recipe-frontend:latest
          
          gcloud run deploy recipe-frontend \
            --image ${{ secrets.DOCKERHUB_USERNAME }}/recipe-frontend:latest \
            --region us-central1 \
            --allow-unauthenticated \
            --port 80
      
      - name: Show URLs
        run: |
          FRONTEND_URL=$(gcloud run services describe recipe-frontend --region us-central1 --format="value(status.url)")
          echo "ðŸŽ‰ DEPLOYMENT COMPLETE!"
          echo "Frontend: $FRONTEND_URL"
          echo "Backend: $BACKEND_URL"